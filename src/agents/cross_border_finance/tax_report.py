import io
from datetime import datetime

import pandas as pd
import streamlit as st
from jinja2 import Template
from weasyprint import HTML

# ==========================================
# 1. ATO æŠ¥è¡¨ HTML æ¨¡æ¿ (Jinja2)
# ==========================================
ATO_REPORT_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: sans-serif; font-size: 12px; }
        .header { text-align: center; margin-bottom: 20px;
                  border-bottom: 2px solid #000; padding-bottom: 10px; }
        .title { font-size: 18px; font-weight: bold; }
        .subtitle { font-size: 14px; color: #555; }
        .section { margin-bottom: 15px; }
        .section-title { font-weight: bold; background-color: #eee;
                         padding: 5px; margin-bottom: 5px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-item { margin-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
        th { background-color: #f9f9f9; }
        .total-row { font-weight: bold; background-color: #eee; }
        .signature-box { margin-top: 30px; border: 1px solid #000; padding: 20px; height: 50px; }
        .footer { margin-top: 50px; text-align: center; font-size: 10px; color: #888; }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">Australian Taxation Office</div>
        <div class="subtitle">Cross-Border Goods Trade Declaration (Form N10)</div>
    </div>

    <div class="section">
        <div class="section-title">Section A: Taxpayer Information</div>
        <div class="info-grid">
            <div class="info-item"><strong>ABN:</strong> {{ abn }}</div>
            <div class="info-item"><strong>Company Name:</strong> {{ company_name }}</div>
            <div class="info-item"><strong>Contact Person:</strong> {{ contact }}</div>
            <div class="info-item"><strong>Report Date:</strong> {{ report_date }}</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Section B: Transaction Details</div>
        <table>
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th>Quantity</th>
                    <th>Dutiable Value (AUD)</th>
                    <th>Tax Rate (%)</th>
                    <th>Duty Amount (AUD)</th>
                </tr>
            </thead>
            <tbody>
                {% for item in transactions %}
                <tr>
                    <td>{{ item.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.value }}</td>
                    <td>{{ item.rate }}%</td>
                    <td>{{ item.duty }}</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="2">TOTAL</td>
                    <td>{{ total_value }}</td>
                    <td>-</td>
                    <td>{{ total_duty }}</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <div class="section">
        <div class="section-title">Section C: Declaration</div>
        <p>I declare that the information provided in this report is true and correct.</p>
        <div class="info-item"><strong>Signature:</strong></div>
        <div class="signature-box">
            <!-- Placeholder for electronic signature -->
        </div>
        <div class="info-item"><strong>Date:</strong> {{ report_date }}</div>
    </div>

    <div class="footer">
        Generated by FinAgent Cross-Border Finance Tool on {{ report_date }}
    </div>
</body>
</html>
"""

# ==========================================
# 2. æ ¸å¿ƒé€»è¾‘
# ==========================================


def process_data(df: pd.DataFrame, tax_rate: float) -> pd.DataFrame:
    """
    å¤„ç†CSVæ•°æ®ï¼Œè®¡ç®—ç¨é¢
    """
    # å­—æ®µæ˜ å°„ä¸å¡«å……
    df = df.copy()

    # å°è¯•æ˜ å°„ä¸­æ–‡åˆ—ååˆ°æ ‡å‡†å­—æ®µ
    col_map = {
        "å•†å“åç§°": "item_name",
        "æ•°é‡": "quantity",
        "å®Œç¨ä»·æ ¼": "dutiable_value",
        "Item Name": "item_name",
        "Quantity": "quantity",
        "Dutiable Value": "dutiable_value",
    }

    # é‡å‘½åå­˜åœ¨çš„åˆ—
    df.rename(
        columns={k: v for k, v in col_map.items() if k in df.columns}, inplace=True
    )

    # ç¡®ä¿å¿…è¦åˆ—å­˜åœ¨ï¼Œç¼ºå¤±å¡«å…… "æ— " æˆ– 0
    required_cols = {
        "item_name": "æ—  (Unknown Item)",
        "quantity": 0,
        "dutiable_value": 0.0,
    }

    for col, default in required_cols.items():
        if col not in df.columns:
            df[col] = default
        else:
            df[col] = df[col].fillna(default)

    # è®¡ç®—é€»è¾‘
    # ç¡®ä¿æ•°å€¼ç±»å‹
    df["dutiable_value"] = pd.to_numeric(df["dutiable_value"], errors="coerce").fillna(
        0.0
    )
    df["quantity"] = pd.to_numeric(df["quantity"], errors="coerce").fillna(0)

    df["tax_rate"] = tax_rate
    df["duty_amount"] = df["dutiable_value"] * (tax_rate / 100.0)

    return df


def generate_pdf(context: dict) -> bytes:
    """
    ä½¿ç”¨ Jinja2 æ¸²æŸ“ HTML å¹¶é€šè¿‡ WeasyPrint è½¬æ¢ä¸º PDF
    """
    template = Template(ATO_REPORT_TEMPLATE)
    html_content = template.render(context)

    # ç”Ÿæˆ PDF
    pdf_file = io.BytesIO()
    HTML(string=html_content).write_pdf(pdf_file)
    pdf_file.seek(0)
    return pdf_file.getvalue()


# ==========================================
# 3. Streamlit UI
# ==========================================
def app():
    st.title("ğŸ§¾ ATOè·¨å¢ƒè´§ç‰©è´¸æ˜“ç¨åŠ¡æŠ¥è¡¨ç”Ÿæˆå™¨")

    # Sidebar: é…ç½®
    with st.sidebar:
        st.header("1. çº³ç¨äººä¿¡æ¯é…ç½®")
        abn = st.text_input("ABN (Australian Business Number)", value="12 345 678 901")
        company_name = st.text_input("å…¬å¸åç§°", value="Example Trading Pty Ltd")
        contact = st.text_input("è”ç³»äºº", value="John Doe")

        st.header("2. ç¨ç‡é…ç½®")
        tax_rate = st.slider("å…³ç¨ç¨ç‡ (%)", 0.0, 20.0, 5.0, 0.5)

        st.markdown("---")
        st.markdown("### æ¨¡æ¿ä¸‹è½½")
        template_df = pd.DataFrame(
            {
                "å•†å“åç§°": ["ç”µå­å…ƒä»¶", "çººç»‡å“"],
                "æ•°é‡": [1000, 500],
                "å®Œç¨ä»·æ ¼": [50000.00, 12000.50],
            }
        )
        st.download_button(
            "ğŸ“¥ ä¸‹è½½CSVæ¨¡æ¿",
            template_df.to_csv(index=False).encode("utf-8"),
            "tax_template.csv",
            "text/csv",
        )

    # Main: ä¸Šä¼ ä¸ç”Ÿæˆ
    st.subheader("3. æ•°æ®ä¸Šä¼ ä¸å¤„ç†")
    uploaded_file = st.file_uploader("ä¸Šä¼ äº¤æ˜“æµæ°´CSV", type=["csv"])

    if uploaded_file:
        try:
            raw_df = pd.read_csv(uploaded_file)
            st.write("åŸå§‹æ•°æ®é¢„è§ˆ:", raw_df.head())

            # å¤„ç†æ•°æ®
            processed_df = process_data(raw_df, tax_rate)

            st.subheader("4. ç¨é¢è®¡ç®—ç»“æœ")
            st.dataframe(
                processed_df.style.format(
                    {
                        "dutiable_value": "${:,.2f}",
                        "duty_amount": "${:,.2f}",
                        "tax_rate": "{:.1f}%",
                    }
                )
            )

            # æ±‡æ€»æ•°æ®
            total_value = processed_df["dutiable_value"].sum()
            total_duty = processed_df["duty_amount"].sum()

            c1, c2 = st.columns(2)
            c1.metric("æ€»å®Œç¨ä»·æ ¼ (Total Value)", f"${total_value:,.2f}")
            c2.metric("åº”çº³å…³ç¨æ€»é¢ (Total Duty)", f"${total_duty:,.2f}")

            if st.button("ç”ŸæˆATOç”³æŠ¥PDF"):
                # å‡†å¤‡æ¸²æŸ“ä¸Šä¸‹æ–‡
                transactions = []
                for _, row in processed_df.iterrows():
                    transactions.append(
                        {
                            "name": str(row["item_name"]),
                            "quantity": str(row["quantity"]),
                            "value": f"${row['dutiable_value']:,.2f}",
                            "rate": f"{row['tax_rate']:.1f}",
                            "duty": f"${row['duty_amount']:,.2f}",
                        }
                    )

                context = {
                    "abn": abn,
                    "company_name": company_name,
                    "contact": contact,
                    "report_date": datetime.now().strftime("%Y-%m-%d"),
                    "transactions": transactions,
                    "total_value": f"${total_value:,.2f}",
                    "total_duty": f"${total_duty:,.2f}",
                }

                with st.spinner("æ­£åœ¨ç”ŸæˆPDFæŠ¥è¡¨..."):
                    try:
                        pdf_bytes = generate_pdf(context)
                        st.success("æŠ¥è¡¨ç”ŸæˆæˆåŠŸï¼")
                        st.download_button(
                            label="ğŸ“„ ä¸‹è½½ATOæŠ¥è¡¨ (PDF)",
                            data=pdf_bytes,
                            file_name=f"ATO_Report_{datetime.now().strftime('%Y%m%d')}.pdf",
                            mime="application/pdf",
                        )
                    except Exception as e:
                        st.error(f"PDFç”Ÿæˆå¤±è´¥: {str(e)}")
                        st.info(
                            "æç¤º: WeasyPrint å¯èƒ½éœ€è¦ç³»ç»Ÿçº§ä¾èµ– "
                            "(libcairo2, libpango-1.0-0 ç­‰)ã€‚"
                            "å¦‚æœè¿è¡Œåœ¨å—é™ç¯å¢ƒï¼Œè¯·è”ç³»ç®¡ç†å‘˜å®‰è£…ã€‚"
                        )

        except Exception as e:
            st.error(f"æ–‡ä»¶å¤„ç†é”™è¯¯: {str(e)}")


if __name__ == "__main__":
    st.set_page_config(page_title="ATOç¨åŠ¡æŠ¥è¡¨ç”Ÿæˆå·¥å…·", page_icon="ğŸ§¾")
    app()
